# 审批系统 - 后端技术实施文档

## 1. 技术概述

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.x | 后端框架 |
| Spring Security | 6.x | 安全框架 |
| MyBatis-Plus | 3.5.x | ORM 框架 |
| JWT | 0.11.x | 身份认证 |
| Maven | 3.9.x | 构建工具 |
| Java | 17+ | 开发语言 |

## 2. 项目初始化

### 2.1 使用 Spring Initializr 创建项目

访问 https://start.spring.io/ 或使用 IDEA 创建：

- Project: Maven
- Language: Java
- Spring Boot: 3.2.x
- Packaging: Jar
- Java: 17

### 2.2 核心依赖 (pom.xml)

```xml
<dependencies>
    <!-- Spring Boot Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- MyBatis-Plus -->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-spring-boot3-starter</artifactId>
        <version>3.5.5</version>
    </dependency>
    
    <!-- MySQL Driver -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
    
    <!-- JWT -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-api</artifactId>
        <version>0.11.5</version>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    
    <!-- Validation -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>
</dependencies>
```

## 3. 项目结构

```
src/main/java/com/approval/
├── ApprovalApplication.java          # 启动类
├── config/                           # 配置类
│   ├── SecurityConfig.java           # 安全配置
│   ├── MybatisPlusConfig.java        # MyBatis-Plus 配置
│   ├── CorsConfig.java               # 跨域配置
│   └── WebMvcConfig.java             # MVC 配置
├── controller/                       # 控制器层
│   ├── AuthController.java           # 认证接口
│   ├── ApprovalController.java       # 审批接口
│   ├── UserController.java           # 用户接口
│   └── FileController.java           # 文件接口
├── service/                          # 服务层
│   ├── AuthService.java
│   ├── ApprovalService.java
│   └── impl/                         # 服务实现
├── mapper/                           # 数据访问层
│   ├── UserMapper.java
│   └── ApprovalMapper.java
├── entity/                           # 实体类
│   ├── User.java
│   ├── Approval.java
│   └── ApprovalNode.java
├── dto/                              # 数据传输对象
│   ├── LoginRequest.java
│   └── ApprovalRequest.java
├── vo/                               # 视图对象
│   ├── UserVO.java
│   └── ApprovalVO.java
├── common/                           # 公共模块
│   ├── Result.java                   # 统一响应
│   ├── PageResult.java               # 分页响应
│   └── ErrorCode.java                # 错误码
├── exception/                        # 异常处理
│   ├── BusinessException.java
│   └── GlobalExceptionHandler.java
├── security/                         # 安全模块
│   ├── JwtTokenProvider.java
│   └── JwtAuthenticationFilter.java
└── util/                             # 工具类
    ├── FileUtil.java
    └── DateUtil.java
```

## 4. 核心配置

### 4.1 应用配置 (application.yml)

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/approval_system?useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
  servlet:
    multipart:
      max-file-size: 50MB
      max-request-size: 50MB

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

# JWT 配置
jwt:
  secret: your-256-bit-secret-key-here
  expiration: 86400000  # 24小时

# 文件上传配置
file:
  upload-dir: D:/uploads/approval-system
  access-path: /files
```

### 4.2 统一响应类 (Result.java)

```java
/**
 * 统一响应结果类
 * @param <T> 响应数据类型
 */
@Data
@Builder
public class Result<T> {
    /** 状态码 */
    private Integer code;
    /** 消息 */
    private String message;
    /** 数据 */
    private T data;
    /** 时间戳 */
    private Long timestamp;

    public static <T> Result<T> success(T data) {
        return Result.<T>builder()
                .code(200)
                .message("success")
                .data(data)
                .timestamp(System.currentTimeMillis())
                .build();
    }

    public static <T> Result<T> error(Integer code, String message) {
        return Result.<T>builder()
                .code(code)
                .message(message)
                .timestamp(System.currentTimeMillis())
                .build();
    }
}
```

### 4.3 全局异常处理

```java
/**
 * 全局异常处理器
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e) {
        log.warn("业务异常: {}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<?> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(", "));
        return Result.error(400, message);
    }

    @ExceptionHandler(Exception.class)
    public Result<?> handleException(Exception e) {
        log.error("系统异常", e);
        return Result.error(500, "服务器内部错误");
    }
}
```

## 5. 安全配置

### 5.1 Security 配置

```java
/**
 * Spring Security 配置类
 */
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .cors(cors -> cors.configure(http))
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/files/**").permitAll()
                .anyRequest().authenticated())
            .addFilterBefore(jwtAuthenticationFilter, 
                UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

### 5.2 JWT Token 工具类

```java
/**
 * JWT Token 提供者
 */
@Component
public class JwtTokenProvider {

    @Value("${jwt.secret}")
    private String jwtSecret;

    @Value("${jwt.expiration}")
    private long jwtExpiration;

    /**
     * 生成 JWT Token
     * @param userId 用户ID
     * @return token 字符串
     */
    public String generateToken(Long userId) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtExpiration);

        return Jwts.builder()
                .setSubject(String.valueOf(userId))
                .setIssuedAt(now)
                .setExpiration(expiryDate)
                .signWith(Keys.hmacShaKeyFor(jwtSecret.getBytes()))
                .compact();
    }

    /**
     * 从 Token 中获取用户ID
     */
    public Long getUserIdFromToken(String token) {
        Claims claims = Jwts.parserBuilder()
                .setSigningKey(Keys.hmacShaKeyFor(jwtSecret.getBytes()))
                .build()
                .parseClaimsJws(token)
                .getBody();
        return Long.valueOf(claims.getSubject());
    }

    /**
     * 验证 Token 是否有效
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder()
                    .setSigningKey(Keys.hmacShaKeyFor(jwtSecret.getBytes()))
                    .build()
                    .parseClaimsJws(token);
            return true;
        } catch (JwtException | IllegalArgumentException e) {
            return false;
        }
    }
}
```

## 6. 开发命令

```bash
# 运行项目
mvn spring-boot:run

# 打包
mvn clean package -DskipTests

# 运行打包后的 jar
java -jar target/approval-system-1.0.0.jar
```

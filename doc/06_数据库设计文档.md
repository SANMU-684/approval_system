# 审批系统 - 数据库设计文档

## 1. 数据库概述

| 项目 | 说明 |
|------|------|
| 数据库 | MySQL 8.0 |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_general_ci |
| 存储引擎 | InnoDB |

## 2. 创建数据库

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS approval_system
    DEFAULT CHARACTER SET utf8mb4
    DEFAULT COLLATE utf8mb4_general_ci;

USE approval_system;
```

## 3. 数据表设计

### 3.1 用户表 (sys_user)

```sql
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码（加密）',
    nickname VARCHAR(50) NOT NULL COMMENT '昵称',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '手机号',
    avatar VARCHAR(255) COMMENT '头像路径',
    role VARCHAR(20) NOT NULL DEFAULT 'USER' COMMENT '角色: USER/ADMIN/SUPER_ADMIN',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_username (username),
    INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 3.2 审批类型表 (approval_type)

```sql
CREATE TABLE approval_type (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '类型ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT '类型编码',
    name VARCHAR(100) NOT NULL COMMENT '类型名称',
    description VARCHAR(500) COMMENT '类型描述',
    icon VARCHAR(50) COMMENT '图标',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审批类型表';

-- 初始化审批类型
INSERT INTO approval_type (code, name, description, icon) VALUES
('LEAVE', '请假申请', '员工请假审批', 'calendar'),
('EXPENSE', '报销申请', '费用报销审批', 'dollar'),
('PURCHASE', '采购申请', '物品采购审批', 'shopping-cart'),
('BUSINESS_TRIP', '出差申请', '出差行程审批', 'plane'),
('OTHER', '其他申请', '其他类型审批', 'file');
```

### 3.3 审批记录表 (approval_record)

```sql
CREATE TABLE approval_record (
    id VARCHAR(36) PRIMARY KEY COMMENT '审批ID (UUID)',
    title VARCHAR(200) NOT NULL COMMENT '审批标题',
    type_code VARCHAR(50) NOT NULL COMMENT '审批类型编码',
    content TEXT COMMENT '审批内容',
    initiator_id BIGINT NOT NULL COMMENT '发起人ID',
    status TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0-草稿 1-待审批 2-审批中 3-已通过 4-已拒绝 5-已撤回',
    current_node_order INT DEFAULT 1 COMMENT '当前审批节点序号',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    completed_at DATETIME COMMENT '完成时间',
    INDEX idx_initiator (initiator_id),
    INDEX idx_type (type_code),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (initiator_id) REFERENCES sys_user(id),
    FOREIGN KEY (type_code) REFERENCES approval_type(code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审批记录表';
```

### 3.4 审批节点表 (approval_node)

```sql
CREATE TABLE approval_node (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '节点ID',
    approval_id VARCHAR(36) NOT NULL COMMENT '审批记录ID',
    approver_id BIGINT NOT NULL COMMENT '审批人ID',
    node_order INT NOT NULL COMMENT '节点顺序',
    status TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0-待审批 1-已通过 2-已拒绝',
    comment VARCHAR(500) COMMENT '审批意见',
    approved_at DATETIME COMMENT '审批时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_approval_order (approval_id, node_order),
    INDEX idx_approval_id (approval_id),
    INDEX idx_approver (approver_id),
    FOREIGN KEY (approval_id) REFERENCES approval_record(id) ON DELETE CASCADE,
    FOREIGN KEY (approver_id) REFERENCES sys_user(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审批节点表';
```

### 3.5 附件表 (attachment)

```sql
CREATE TABLE attachment (
    id VARCHAR(36) PRIMARY KEY COMMENT '附件ID (UUID)',
    approval_id VARCHAR(36) COMMENT '关联审批ID',
    original_name VARCHAR(255) NOT NULL COMMENT '原始文件名',
    stored_name VARCHAR(255) NOT NULL COMMENT '存储文件名',
    file_path VARCHAR(500) NOT NULL COMMENT '文件路径',
    file_size BIGINT NOT NULL COMMENT '文件大小（字节）',
    file_type VARCHAR(50) COMMENT '文件类型',
    mime_type VARCHAR(100) COMMENT 'MIME 类型',
    uploader_id BIGINT NOT NULL COMMENT '上传者ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_approval_id (approval_id),
    INDEX idx_uploader (uploader_id),
    FOREIGN KEY (approval_id) REFERENCES approval_record(id) ON DELETE SET NULL,
    FOREIGN KEY (uploader_id) REFERENCES sys_user(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='附件表';
```

### 3.6 操作日志表 (operation_log)

```sql
CREATE TABLE operation_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    user_id BIGINT NOT NULL COMMENT '操作用户ID',
    module VARCHAR(50) NOT NULL COMMENT '模块名称',
    operation VARCHAR(50) NOT NULL COMMENT '操作类型',
    target_id VARCHAR(36) COMMENT '目标ID',
    detail TEXT COMMENT '操作详情',
    ip_address VARCHAR(50) COMMENT 'IP 地址',
    user_agent VARCHAR(500) COMMENT '用户代理',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_module (module),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';
```

## 4. ER 关系图

```
┌──────────────┐       ┌─────────────────┐       ┌───────────────┐
│   sys_user   │       │ approval_record │       │ approval_type │
├──────────────┤       ├─────────────────┤       ├───────────────┤
│ id (PK)      │◄──────│ initiator_id    │       │ id (PK)       │
│ username     │       │ id (PK)         │──────►│ code (UK)     │
│ password     │       │ title           │       │ name          │
│ nickname     │       │ type_code (FK)  │───────┘               │
│ role         │       │ content         │                       │
│ status       │       │ status          │                       │
└──────────────┘       └─────────────────┘                       │
       ▲                       │                                 │
       │                       │                                 │
       │                       ▼                                 │
       │               ┌───────────────┐                         │
       │               │ approval_node │                         │
       │               ├───────────────┤                         │
       └───────────────│ approver_id   │                         │
                       │ approval_id   │─────┐                   │
                       │ node_order    │     │                   │
                       │ status        │     │                   │
                       │ comment       │     │                   │
                       └───────────────┘     │                   │
                                             │                   │
                       ┌───────────────┐     │                   │
                       │  attachment   │     │                   │
                       ├───────────────┤     │                   │
                       │ id (PK)       │     │                   │
                       │ approval_id   │─────┘                   │
                       │ original_name │                         │
                       │ file_path     │                         │
                       └───────────────┘                         │
```

## 5. 状态枚举

### 审批状态
| 值 | 名称 | 说明 |
|----|------|------|
| 0 | DRAFT | 草稿 |
| 1 | PENDING | 待审批 |
| 2 | IN_PROGRESS | 审批中 |
| 3 | APPROVED | 已通过 |
| 4 | REJECTED | 已拒绝 |
| 5 | WITHDRAWN | 已撤回 |

### 节点状态
| 值 | 名称 | 说明 |
|----|------|------|
| 0 | PENDING | 待审批 |
| 1 | APPROVED | 已通过 |
| 2 | REJECTED | 已拒绝 |

## 6. 初始化数据

```sql
-- 创建管理员账号（密码: admin123）
INSERT INTO sys_user (username, password, nickname, role) VALUES
('admin', '$2a$10$xxx...', '系统管理员', 'SUPER_ADMIN');
```

# 审批系统 - 部署指南

## 1. 系统要求

### 1.1 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|---------|---------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 磁盘 | 50GB | 100GB+ SSD |

### 1.2 软件要求

| 软件 | 版本 |
|------|------|
| 操作系统 | CentOS 7+ / Ubuntu 18.04+ / Windows Server 2016+ |
| JDK | 17+ |
| Node.js | 18+ |
| MySQL | 8.0 |
| Nginx | 1.20+ |

## 2. 环境部署

### 2.1 安装 JDK 17

```bash
# CentOS/RHEL
sudo yum install java-17-openjdk java-17-openjdk-devel

# Ubuntu
sudo apt install openjdk-17-jdk

# 验证安装
java -version
```

### 2.2 安装 MySQL 8.0

```bash
# CentOS/RHEL
sudo yum install mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 初始化数据库
mysql_secure_installation

# 创建数据库和用户
mysql -u root -p
```

```sql
CREATE DATABASE approval_system DEFAULT CHARACTER SET utf8mb4;
CREATE USER 'approval'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON approval_system.* TO 'approval'@'localhost';
FLUSH PRIVILEGES;
```

### 2.3 安装 Node.js 18

```bash
# 使用 nvm 安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18

# 安装 pnpm
npm install -g pnpm
```

### 2.4 安装 Nginx

```bash
# CentOS/RHEL
sudo yum install nginx

# Ubuntu
sudo apt install nginx

# 启动
sudo systemctl start nginx
sudo systemctl enable nginx
```

## 3. 项目部署

### 3.1 后端部署

```bash
# 1. 克隆项目
git clone <repository-url>
cd approval-system/backend

# 2. 修改配置
cp src/main/resources/application-prod.yml.example src/main/resources/application-prod.yml
vim src/main/resources/application-prod.yml

# 3. 打包
mvn clean package -Pprod -DskipTests

# 4. 部署
mkdir -p /opt/approval-system
cp target/approval-system-1.0.0.jar /opt/approval-system/

# 5. 创建启动脚本
cat > /opt/approval-system/start.sh << 'EOF'
#!/bin/bash
cd /opt/approval-system
nohup java -jar -Dspring.profiles.active=prod approval-system-1.0.0.jar > app.log 2>&1 &
echo $! > app.pid
EOF
chmod +x /opt/approval-system/start.sh

# 6. 创建停止脚本
cat > /opt/approval-system/stop.sh << 'EOF'
#!/bin/bash
kill $(cat /opt/approval-system/app.pid)
EOF
chmod +x /opt/approval-system/stop.sh

# 7. 启动应用
/opt/approval-system/start.sh
```

### 3.2 前端部署

```bash
# 1. 进入前端目录
cd approval-system/frontend

# 2. 安装依赖
pnpm install

# 3. 构建
pnpm build

# 4. 部署到 Nginx
sudo cp -r dist/* /var/www/approval-system/
```

### 3.3 Nginx 配置

```nginx
# /etc/nginx/conf.d/approval-system.conf
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    root /var/www/approval-system;
    index index.html;

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 文件访问
    location /files {
        alias /data/uploads/approval-system;
        expires 7d;
    }

    # Gzip 压缩
    gzip on;
    gzip_types text/plain application/json application/javascript text/css;
}
```

```bash
# 测试配置
sudo nginx -t

# 重载配置
sudo nginx -s reload
```

## 4. 创建系统服务 (可选)

```bash
# /etc/systemd/system/approval-system.service
[Unit]
Description=Approval System Backend
After=network.target mysql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/approval-system
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod approval-system-1.0.0.jar
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启用服务
sudo systemctl daemon-reload
sudo systemctl enable approval-system
sudo systemctl start approval-system

# 查看状态
sudo systemctl status approval-system
```

## 5. 配置文件存储目录

```bash
# 创建上传目录
sudo mkdir -p /data/uploads/approval-system
sudo chown -R www-data:www-data /data/uploads

# 确保应用有写入权限
```

## 6. 数据库初始化

```bash
# 导入表结构
mysql -u approval -p approval_system < sql/schema.sql

# 导入初始数据
mysql -u approval -p approval_system < sql/init-data.sql
```

## 7. 常用运维命令

```bash
# 查看应用日志
tail -f /opt/approval-system/app.log

# 重启应用
sudo systemctl restart approval-system

# 查看端口占用
netstat -tlnp | grep 8080

# 查看磁盘使用
df -h

# 查看内存使用
free -m
```

## 8. 安全加固

1. **防火墙配置**
```bash
# 仅开放必要端口
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

2. **HTTPS 配置**
```bash
# 使用 Let's Encrypt 获取证书
sudo certbot --nginx -d your-domain.com
```

3. **数据库安全**
- 不使用 root 账号
- 限制数据库访问 IP
- 定期备份

## 9. 备份策略

```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
mysqldump -u approval -p approval_system > /backup/db_$DATE.sql
find /backup -name "db_*.sql" -mtime +7 -delete

# 文件备份
rsync -av /data/uploads/approval-system/ /backup/files/
```

## 10. 监控建议

- 使用 Prometheus + Grafana 监控系统指标
- 使用 ELK 收集和分析日志
- 配置告警通知（邮件、钉钉等）
